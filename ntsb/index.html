<!DOCTYPE html>
<meta charset="utf-8">
<style>

.background {
  fill: none;
  pointer-events: all;
}

#states {
  fill: #aaa;
}

#state-borders {
  fill: none;
  stroke: #fff;
  stroke-width: 1.5px;
  stroke-linejoin: round;
  stroke-linecap: round;
  pointer-events: none;
}

.details {
  display: none;
  background-color: #EFEFEF;
  padding: 5px;
}

table tr td {
  padding: 5px 10px 5px 10px;
}

#name {
  padding: 0;
  margin: 0 0 5px 8px;
}

</style>
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<body>

<div class="col-md-2">
  <h3>Aviation Accidents</h3>
  <p>
    Select attribute to normalize by:
    <select id="normalizeSelect" onchange="addData($(this).val())">
      <option value="operations">Operations</option>
      <option value="population">Population</option>
      <option value="none">No normalization</option>
    </select>
  </p>
  <p>Select a state to view its accident rate.</p>
  <div class="details">
    <p>
      <h3 id="name"></h3>
      <table>
        <tr>
          <td>
            Population<br />
            <small>estimated, 2016</small>
          </td>
          
          <td id="population"></td>
        </tr>
        <tr>
          <td>
            Operations<br />
            <small>Since 1989</small>
          </td>
          <td id="operations"></td>
        </tr>
        <tr>
          <td>
            Accidents<br />
            <small>Since 1982</small>
          </td>
          <td id="accidents"></td>
        </tr>
        <tr id="ifNormalized">
          <td>
            Accident Rate<br />
            <small>Norm. by <span id="normalizeBy"></span></small>
          </td>
          <td id="rate"></td>
        </tr>
      </table>
    </p>
  </div>
</div>

<div id="content" class="col-md-10">

</div>


<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="//d3js.org/d3.v4.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script>

var width = 960,
    height = 500,
    centered;

var projection = d3.geoAlbersUsa()
    .scale(1070)
    .translate([width / 2, height / 2]);

var path = d3.geoPath()
    .projection(projection);

var svg = d3.select("#content").append("svg")
    .attr("width", width)
    .attr("height", height);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", clicked);

var g = svg.append("g");

d3.json("us.json", function(error, us) {
  if (error) throw error;

  var stateContainer = g.append("g")
      .attr("id", "states")
    .selectAll("path")
      .data(topojson.feature(us, us.objects.states).features)
    .enter().append('g')
    .attr('id', function(d) { return "state-" + d.id; });

  var statePaths = stateContainer.append("path")
      .attr("d", path)
      .attr("class", "state")
      .on("click", clicked);

  g.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("id", "state-borders")
      .attr("d", path);

  addData("operations");

});

function clicked(d) {

  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 4;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; })
      .attr('opacity', function(d) {
          if(!centered) { return 1 };
          if(d !== centered) { return 0.2 };
        });

  g.transition()
      .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");

  if(centered) {
    // Display details in side panel
    $(".details").css('display','block');
    changeDataDisplay(d);
  } else {
    $(".details").css('display','none');
  }

}

function changeDataDisplay(d) {
    $("#name").html(d.name + " ("+ d.abbreviation +")");
    $("#population").html(numberWithCommas(d.population));
    $("#accidents").html(numberWithCommas(d.accidents));
    $("#operations").html(numberWithCommas(d.operations));
    $("#rate").html(d.rate); 
}

function addData(normalizeBy) {

  $("#normalizeBy").html(normalizeBy);

  // If not normalizing, don't show a rate
  if(normalizeBy == "none") $("#ifNormalized").css("display", "none");
    else $("#ifNormalized").css("display", "table-row");

  // Get individual state data and map to path
  d3.json("states.json?nocache=" + (new Date()).getTime(), function(error, data) {

    var minScale = null;
    var maxScale = null;

    data.forEach(datum => {
      if(normalizeBy == "none") datum[normalizeBy] = 1;
      // Set max and min populations for color interpolation
      if(!minScale || datum.accidents/datum[normalizeBy] < minScale) minScale = datum.accidents/datum[normalizeBy];
      if(!maxScale || datum.accidents/datum[normalizeBy] > maxScale) maxScale = datum.accidents/datum[normalizeBy];
      // Save the custom data to the appropriate d3 data object
      d3.select("#state-"+datum.id).each(function(d){
        d.population = datum.population;
        d.name = datum.name;
        d.abbreviation = datum.abbreviation;
        d.accidents = datum.accidents;
        d.rate = (datum.accidents / datum[normalizeBy]).toFixed(5);
        d.operations = datum.operations;
        d.none = 1;
      });

    });

    // Apply population interpolation for each state
    d3.selectAll(".state")
      .transition().duration(1000)
      .attr('fill', function(d) {
        var t = 1 - (d.accidents/d[normalizeBy] - minScale) / (maxScale - minScale);
        return d3.interpolateRdYlGn(t);
      });

    // If a state is currently selected, change the data display appropriately
    d3.select(".active").each(function(d){
      changeDataDisplay(d);
    });

  });

}

function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

</script>